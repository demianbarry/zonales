#summary Instalación de múltiples instancias de MySQL 5.x en RHEL5.
#labels Phase-Deploy,Phase-Implementation

= Introducción =

Se hará uso del comando [http://dev.mysql.com/doc/refman/5.0/en/mysqld-multi.html mysqld_multi] de MySQL, que permite especificar múltiples configuraciones en el archivo `my.cnf`, cada una bajo un grupo `[mysqldN]`, donde *N* es el número de instancia. 

Una vez modificado el archivo `my.cnf`, se crearán los scripts de inicio a partir del script `/etc/init.d/mysqld`.

== my.cnf ==

Primero, crearemos una copia `my.cnf` en donde configuraremos las instancias que vamos a utilizar: 

`cp /etc/my.cnf /etc/my.multi.cnf`

Luego reemplazamos el contenido de los nuevos archivos por lo siguiente, modificando donde sea neceario:

{{{
[mysqld_multi]
mysqld=/usr/bin/mysqld_safe
mysqladmin=/usr/bin/mysqladmin
user=admin
password=adminpass

[mysqld1]
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
user=mysql
# Default to using old password format for compatibility with mysql 3.x
# clients (those using the mysqlclient10 compatibility package).
old_passwords=1
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
port=3306

[mysqld2]
datadir=/var/lib/mysql2
socket=/var/lib/mysql2/mysql.sock
user=mysql
# Default to using old password format for compatibility with mysql 3.x
# clients (those using the mysqlclient10 compatibility package).
old_passwords=1
log-error=/var/log/mysqld2.log
pid-file=/var/run/mysqld/mysqld2.pid
port=3307
}}}

Es importante que cada instancia cuenta con su propio `log-error`, `pid-file`, `socket`, `datadir` y `port`. En el ejemplo se siguio la convención de directorios y nombres de RHEL5.

== scripts administrativos ==

Para crear los scripts con los cuales iniciaremos y detendremos las instancias de MySQL, crearemos nuevas copias del archivo `/etc/init.d/mysqld`, las cuales modificaremos acordemente:

`cp /etc/init.d/mysqld /etc/init.d/mysqld1 /etc/init.d/mysqld2`

En cada archivo, modificamos el primer argumento de las invocaciones a la función `get_mysql_option` por el nombre de la sección correspondiente (`mysqld1`, `mysqld2`, etc):

{{{
get_mysql_option mysqld1 datadir "/var/lib/mysql"
datadir="$result"
}}}

A continuación modificamos la líneas que ejecutan `/usr/bin/mysqld_safe` en la función `start()` para llamar a `mysqld_multi`:

{{{
/usr/bin/mysqld_multi --defaults-file=/etc/my.multi.conf --mysqld=mysqld_safe start 1 >/dev/null 2>&1 &
}}}

Finalmente agregamos los scripts creados como nuevos servicios del sistema:

`chkconfig -add /etc/init.d/mysqld1`
`chkconfig -add /etc/init.d/mysqld2`

De esta manera podremos iniciar cada instancia mediante el comando `service`.

== Notas ==

Al reutilizar el script `mysqld` de RH, al crear una nueva instancia e iniciarla, automaticamente se creará el directorio de datos, se setearán los permisos del mismo y se iniciará la base de dato (de manerá identica al iniciar por primera vez el servicio `mysqld`).

La instancia original de MySQL sigue estando disponible en el sistema, coexistiendo con las nuevas.